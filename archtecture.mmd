%%{init: {'theme': 'default', 'themeVariables': { 'fontSize': '13px', 'fontFamily': 'monospace' }}}%%
flowchart LR
    classDef api fill:#d0ebff,stroke:#1976d2,color:#0d47a1;
    classDef input fill:#fff8e1,stroke:#f57f17,color:#ff6f00;
    classDef engine fill:#e8f5e9,stroke:#388e3c,color:#1b5e20;
    classDef udpFlow fill:#e3f2fd,stroke:#1565c0,color:#0d47a1;
    classDef tcpFlow fill:#ffebee,stroke:#d32f2f,color:#b71c1c;
    classDef bannerProcess fill:#f3e5f5,stroke:#7b1fa2,color:#4a148c;
    classDef output fill:#e0f7fa,stroke:#0097a7,color:#006064;
    classDef contexts fill:#f1f8e9,stroke:#689f38,color:#33691e;

    %% --- API ENTRYPOINT ---
    A["Caller (lib user/tests)"]:::api
    A --> B["core::model::Config"]:::api
    A --> C["OutputChannel::new"]:::output
    B --> D["Engine::new"]:::engine
    C --> D
    D --> E["Engine::run"]:::engine

    %% --- INPUT RESOLUTION ---
    E --> F["input::stream_targets"]:::input
    F --> G{"Config target?"}:::input
    G -->|Single target| H["TargetSpec"]:::input
    G -->|Input file| I["read_file + parse_target"]:::input
    H --> J["lookup_host (DNS)"]:::input
    I --> J
    J --> K["Target(s) resolved"]:::input

    %% --- ENGINE CONTROL ---
    E --> L["RateLimiter + Semaphore"]:::engine
    L --> M["spawn task per target\n(overall timeout)"]:::engine
    K --> M

    %% --- PIPELINE ---
    M --> N["pipeline::process_target"]:::engine
    N --> O{"Active mode\n+ UDP client?"}:::udpFlow

    %% --- UDP PATH ---
    O -->|Yes| P["udp_client.execute"]:::udpFlow
    P --> Q["ReadResult"]:::udpFlow
    Q --> R["BannerReader.render"]:::bannerProcess
    R --> S["ScanOutcome (UDP)"]:::bannerProcess

    %% --- TCP PATH ---
    O -->|No| T["connect_tcp"]:::tcpFlow
    T --> U{"TCP ok?"}:::tcpFlow
    U -->|Error/timeout| V["ScanOutcome\nerror/timeout"]:::tcpFlow
    U -->|Ok| W["process_tcp_stream"]:::tcpFlow

    W --> X{"Client?"}:::bannerProcess
    X -->|Active client| Y["Client.execute"]:::bannerProcess
    X -->|No client| Z{"Prober?"}:::bannerProcess
    Z -->|Active prober| AA["Prober.execute"]:::bannerProcess
    Z -->|No prober| AB["BannerReader.read"]:::bannerProcess

    Y --> AC["ReadResult"]:::bannerProcess
    AA --> AC
    AB --> AC
    AC --> AD["BannerReader.render â†’ Banner"]:::bannerProcess
    AD --> AE["Fingerprint + TLS + Diagnostics"]:::bannerProcess

    AE --> AF{"webdriver/tech\nfeatures enabled?"}:::bannerProcess
    AF -->|webdriver| AG["contexts::web::webdriver"]:::bannerProcess
    AF -->|tech scan| AH["wappalyzer (web)"]:::bannerProcess
    AF -->|none| AI["no extras"]:::bannerProcess

    %% --- OUTPUT ---
    S --> AJ["OutputChannel.emit"]:::output
    V --> AJ
    AE --> AJ
    AG --> AJ
    AH --> AJ
    AI --> AJ
    AJ --> AK["OutputSink.write_outcome"]:::output
    AK --> AL["stdout\n(JSONL/Pretty)"]:::output

    %% --- CONTEXT REGISTRY ---
    subgraph Contexts ["Contexts (registry)"]
        class Contexts contexts
        CR["contexts::registry\nclient_for_target /\nudp_client_for_target /\nprobe_for_target"]:::contexts
        CR --> C1["db"]
        CR --> C2["mail"]
        CR --> C3["infra"]
        CR --> C4["web"]
    end

    N --> CR
